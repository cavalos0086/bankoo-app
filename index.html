<html ng-app="bankooTest">

<head>
	<script src="bower_components/angular/angular.min.js"></script>
	<script>
		angular.module("bankooTest", [])
			.controller("mainController", mainController);

		function run(supportedPaymentMethod) {
			if (window.PaymentRequest) {
				initPaymentRequestApi(supportedPaymentMethod);
			} else {
				console.log("Payment Request Not Found");
			}

		}

		function initPaymentRequestApi(supportedPaymentMethod) {
			var supportedInstruments = [
				{
					supportedMethods: supportedPaymentMethod,
					data: {
						//merchant ID obtained from Google that maps to your origin
						merchantId: '02510116604241796260',
						environment: 'TEST',
						// Credit Cards allowed via Android Pay
						allowedCardNetworks: ['MASTERCARD', 'VISA'],
						paymentMethodTokenizationParameters: {
							tokenizationType: 'GATEWAY_TOKEN',
							parameters: {
								'gateway': 'stripe',
								// Place your own Stripe publishable key here.
								'stripe:publishableKey': 'pk_live_fD7ggZCtrB0vJNApRX5TyJ9T',
								'stripe:version': '2016-07-06'
							}
						}
					}
				}
			];

			var paymentDetails = {
				total: {
					label: 'mechantName',
					amount: {
						currency: 'USD',
						value: '20',
					},
				},
			};

			window.paymentRequest = new window.PaymentRequest(supportedInstruments, paymentDetails);
		}

		function mainController($scope) {
			var vm = this;
			vm.counter = 0;
			vm.isSecureContext = window.isSecureContext;
			vm.handleClick = handleClick;
			vm.callCanMakePayment = callCanMakePayment;
			vm.useAndroid = useAndroid;
			vm.useMasterpass = useMasterpass;
			vm.useSamsungPay = useSamsungPay;
			vm.useTwo = useTwo;
			vm.useAll = useAll;
			vm.useCardsOnly = useCardsOnly;
			vm.apiPresent = !!window.PaymentRequest;
			vm.supportedPaymentMethod = ['https://masterpass-payment-api.herokuapp.com/'];

			function useMasterpass() {
				vm.supportedPaymentMethod = ['https://masterpass-payment-api.herokuapp.com/'];
			}

			function useAndroid() {
				vm.supportedPaymentMethod = ['https://android.com/pay'];
			}

			function useCardsOnly() {
				vm.supportedPaymentMethod = ['basic-card'];
			}

			function useSamsungPay() {
				vm.supportedPaymentMethod = ['https://samsung.com/pay'];
			}

			function useAll() {
				vm.supportedPaymentMethod = ['basic-card', 'https://android.com/pay', 'https://masterpass-payment-api.herokuapp.com/', 'https://samsung.com/pay']
			}

			function useTwo() {
				vm.supportedPaymentMethod = ['https://android.com/pay', 'https://masterpass-payment-api.herokuapp.com/']
				console.log('*****', 'using two only android and bankoo');
			}

			function handleError(err) {
				if (err.message === "Request cancelled") {
					vm.requestStatus = "Request Cancelled";
				}
				alert(err)
			}

			function handleClick(e) {
				run(vm.supportedPaymentMethod);

				// window.paymentRequest.canMakePayment().then(function (canMakePayment) {
				// 	console.log(canMakePayment)
				// 	vm.canMakePayment = canMakePayment;
				// 	window.paymentRequest.show()
				// 		.then(handleResponse)
				// 		.catch(handleError);
				// })
				window.paymentRequest.show()
				.then(handleResponse)
				.catch(handleError);
			}

			function handleResponse(checkoutResponse) {
				checkoutResponse.complete('success');
			}

			function callCanMakePayment() {
				run(vm.supportedPaymentMethod);
				window.paymentRequest.canMakePayment()
					.then(function(succ) {
						vm.counter++;
						console.log('*****', succ);
						console.log('*****', vm.counter);
					})
					.catch(function(err) {
						console.log('*****', err);
					})
			}
		}
	</script>
</head>

<body ng-controller="mainController as vm">
	<h1>Is Secure Context {{vm.isSecureContext}}</h1>
	<h1>Api Present {{vm.apiPresent}}</h1>
	<h1 ng-show="vm.apiPresent">Can Make Payment {{vm.canMakePayment}}</h1>
	<div>
		<h4>{{vm.supportedPaymentMethod}}</h4>
		<button ng-click="vm.useAndroid()">Use Android Pay</button>
		<button ng-click="vm.useMasterpass()">Use Masterpass Pay</button>
		<button ng-click="vm.useCardsOnly()">use basic-card only</button>
		<button ng-click="vm.useTwo()">Use AndroidPay and Bankoo</button>
		<button ng-click="vm.useAll()">Use All</button>
		<button ng-click="vm.useSamsungPay()">use Samsung Pay</button>
	</div>
	<button ng-click="vm.handleClick()">Send Request</button>
	<button ng-click="vm.callCanMakePayment()">call canMakePayment</button>
	<h1>{{vm.requestStatus}}</h1>
	<h1>{{vm.counter}}</h1>
</body>

</html>